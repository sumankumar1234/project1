---
- name: Azure VM - Linux
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Create a virtual network
      azure_rm_virtualnetwork:
        resource_group: linux-prj-resources
        name: lnx_network
        address_prefixes: "10.0.0.0/16"
                 
    - name: Create a subnet
      azure_rm_subnet:
        resource_group: lnx_SN
        virtual_network: lnx_network
        name: hosts
        address_prefix: "10.0.1.0/24"

    - name: Create a public IP address
      azure_rm_publicipaddress:
       resource_group: linux-prj-resources
       allocation_method: Static
       name: ubuntulinux-pub-ip

    - name: Create a Network Security Group and Open SSH port
      azure_rm_securitygroup:
        resource_group: linux-prj-resources
        name: wsl_nsg
        rules:
          - name: RDP
            protocol: Tcp
            destination_port_range: 22
            access: Allow
            priority: 100
            direction: Inbound 

    - name: Create a virtual network interface card
      azure_rm_networkinterface:
        resource_group: linux-prj-resources
        name: wsl_nic
        virtual_network: lnx_network
        subnet: hosts
        public_ip_name: ubuntulinux-pub-ip
        security_group: wsl_nsg            

    - name: Create a VM with a managed disk 
      azure_rm_virtualmachine:
        resource_group: linux-prj-resources
        name: ansiblevm
        admin_username: vmadmin
        admin_password: Ahlstrom@123
        ssh_public_keys:
          - path: /home/vadmin/.ssh/authorized_keys
            key_data: Paste SSH public key here
        managed_disk_type: Standard_LRS
        image:
          offer: 0001-com-ubuntu-server-focal
          publisher: canonical
          sku: 20_04-lts
          version: latest
        vm_size: Standard_ds1_v2
        os_type: Linux
        network_interfaces: lnx_nic